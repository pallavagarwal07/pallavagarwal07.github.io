<title>Automating HTTPS certs using Namesilo and Letsencrypt - VARSTACK</title>
<div id="fb-root"></div>
<script>(function(d, s, id) {
var js, fjs = d.getElementsByTagName(s)[0];
if (d.getElementById(id)) return;
js = d.createElement(s); js.id = id;
js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";
fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
var host = "varstack.com";
var hostwww = "www.varstack.com";
if (((host == window.location.host) || (hostwww == window.location.host))
        && (window.location.protocol != 'https:'
            || window.location.toString().match(/http.?:\/\/var/))){
  window.location = window.location.toString().replace(/^http:/, "https:").replace(/https:\/\/varstack/, "https://www.varstack");
}
</script>
<meta name=viewport content="width=device-width, initial-scale=1">
<meta charset="utf-8"/>

<noscript>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/highlighting.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    
    
</noscript>

<script id="loadcss">function loadCSS(e,n,o,t){"use strict";var d=window.document.createElement("link"),i=n||window.document.getElementsByTagName("script")[0],r=window.document.styleSheets;return d.rel="stylesheet",d.href=e,d.media="only x",t&&(d.onload=t),i.parentNode.insertBefore(d,i),d.onloadcssdefined=function(e){for(var n,o=0;o<r.length;o++)r[o].href&&r[o].href===d.href&&(n=!0);n?e():setTimeout(function(){d.onloadcssdefined(e)})},d.onloadcssdefined(function(){d.media=o||"all"}),d}
loadCSS( "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css", document.getElementById("loadcss"));
loadCSS( "/css/highlighting.css", document.getElementById("loadcss"));
loadCSS( "/css/style.css", document.getElementById("loadcss"));
    
    
</script>

<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
    <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    
    <img src="/img/https.png" id="bg-img" alt="Logos of Namesilo, Letsencrypt, Certbot and GitLab">
    
    <div class="container">
        <div class="row" id="menu">
            <div class="col-sm-2 col-xs-2 menu" id="site_title">
                <a href="/" style="color:black;">
                    <img src="/img/logo.png" style="max-height:90%;">
                </a>
            </div>
            <div class="col-sm-6 col-xs-10 menu">
                <div class="row" id="top_menu">
                    <ul class="nav nav-pills">
                        <li class="active" id="blog"><a class="color_change" href="/">Blog</a></li>
                        <li class="" id="tips"><a class="color_change" href="/tips/">Tips</a></li>
                        <li class="" id="algo"><a class="color_change" href="/algo/">Behind The Scenes</a></li>
                        <li class="" id="about"><a class="color_change" href="/about_me/">About Me</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-4 col-xs-12 menu">
                <form action="/search/" id='search-form'>
                    <input id="search-box" type="text" name="query" placeholder="Search..">
                </form>
            </div>
        </div>
        
        <div class="row" id="image"> </div>
        
        <div class="row" id="content">
            <div class="col-md-7 col-md-push-3">
                <div class="row" id="data">
                    <div class="col-md-12">
                        <br />
                        <h3 id="page_title">Automating HTTPS certs using Namesilo and Letsencrypt</h3>
                        <hr />
                        <div class="row text-justify" id="content-holder">
                            <div class="col-md-12">
                                <h3>TL;DR</h3>

<p>I automated the procedure of obtaining and installing HTTPS certificates for
all my domains and subdomains using the APIs provided by Namesilo (my registrar),
GitLab (my host), and Certbot (certificate issuing package).</p>

<h3>Long version</h3>

<p>Not being on https is seriously bad for your website. Leaving out the actual
security issues of not using https, the <a href="https://searchengineland.com/google-emails-warnings-webmasters-chrome-will-mark-http-pages-forms-not-secure-280907">policy changes in Google
Chrome</a>
also make a non-https website look bad to an end user. I shifted this blog to
https more than an year ago (May 2016) and since then I have been using
certificates generated by Letsencrypt for this blog.</p>

<p>If you do not know about Letsencrypt, I suggest you go ahead and read about it
<a href="https://letsencrypt.org/about/">here</a>. In short, it provides free trusted SSL
certificates for people to enable SSL on their websites. A certificate is valid
for 3 months, after which the owner must renew the certificate by providing
proof of domain ownership again.</p>

<h3>Proving domain ownership</h3>

<p>To prove that you have control over a domain name, you need to solve one of
multiple challenges:</p>

<ol>
<li>Posting a specified file in a specified location on a web site (the HTTP-01
challenge)</li>
<li>Offering a specified temporary certificate on a web site (the TLS-SNI-01
challenge)</li>
<li>Posting a specified DNS record in the domain name system (the DNS-01
challenge)</li>
</ol>


<p>Traditionally, I have always used either (1) or (3) manually to obtain my
certificates. However, as the number of domains/sub-domains for which I need
to generate these certificates increases, doing this manually for each one
starts to suck. A couple of days ago, I decided to automate the whole process
so that I don't have to think twice before using a sub-domain (no thinking - oh
no, not another one) or getting a new domain.</p>

<h3>Choosing the correct challenge</h3>

<p><br/></p>

<h4><strong>HTTP-01</strong></h4>

<p>HTTP-01 challenge would have been the easiest to automate. However, it
restricts the locations for which I can generate the certificate. Specifically,
since the HTTP-01 challenge requires showing a particular file at a specified
URL on that domain, it needs to be a server that's hosting a website. But what
if it isn't? For instance <code>alexa.pallav.xyz</code> only hosts an instance of the
<a href="https://github.com/stevenleeg/geemusic">GeeMusic</a> server. Since there are no
HTTP pages served, it can't participate in HTTP-01 challenge.</p>

<p>Also, I tend to change the way my website is generated and/or hosted. Any
change would require corresponding changes to the automation script which is
unacceptable.</p>

<p><br/></p>

<h4><strong>TLS-SNI-01</strong></h4>

<p>This one has the same problem as the former challenge. Every server has a
different way of serving certificates. The script would need to be tuned for
each server. <strong>Any domain/subdomain currently not in use would not be included
for certificate generation.</strong></p>

<p><br/></p>

<h4><strong>DNS-01</strong></h4>

<p>DNS-01 was the clear winner. DNS changes don't require any interaction with the
domain host, but rather with the registrar or the DNS provider. Since the
probability of me changing registrars is quite low, the automation script would
be able to generate certificates of all domains registered with Namesilo.</p>

<p>This automatically also takes care of any subdomains I create of the existing
domain names, since they are also under the same registrar.</p>

<p><br/></p>

<h3>Automation!</h3>

<p>So here's the steps:</p>

<ol>
<li>Call certbot for all domains. Indicate preference for DNS-01 challenge.</li>
<li>For each domain, use the Namesilo API to update the DNS record as indicated
by certbot.</li>
<li>Stall the script for 15 minutes to let the DNS record update be published.</li>
<li>Let certbot run the verification.</li>
<li>Use the GitLab API to install the newly generated certificate into the pages
hosted by GitLab.</li>
</ol>


<p><strong>Step 1: Calling certbot</strong></p>

<p>If you have used certbot before, you'd know that by default it runs in an
interactive mode. Clearly, if we want to run it inside a script, interactive
mode would be <em>undesirable</em>. Similarly, since the certificates need to be
installed on GitLab and not on local server, we need the <code>--manual</code> and
<code>certonly</code> modes. After some experimentation, I was able to come up with a
launch command that runs the certbot non-interactively, and without any
complications.</p>

<pre><code>certbot     --config-dir ${DIR}/gen/conf      \
            --work-dir ${DIR}/gen/work        \
            --logs-dir ${DIR}/gen/logs        \
            --agree-tos                       \
            -m pallavagarwal07@gmail.com      \
            -d pallav.xyz                     \
            -d www.pallav.xyz                 \
            -d alexa.pallav.xyz               \
            -d varstack.com                   \
            -d www.varstack.com               \
            --manual                          \
            --manual-public-ip-logging-ok     \
            --preferred-challenges dns        \
            --noninteractive                  \
            --manual-auth-hook ${DIR}/hook.sh \
            certonly
</code></pre>

<p>The first 3 lines just indicate the preference of where I'd like the
certificate and other artifcats to be generated. Most of the other flags are
rather self explanatory. Flags like <code>--agree-tos</code> and
<code>--manual-public-ip-logging-ok</code> just prevent the script from asking the user
for permissions. The use of most flags can be understood by running</p>

<pre><code>certbot --help
</code></pre>

<p>The flag of interest is <code>--manual-auth-hook</code>. This flag specifies the
executable to be called for the completion of the challenge for each domain
name (in this case, the challenge is <code>DNS-01</code>).</p>

<p>The challenge executable in my case can be found
<a href="https://github.com/pallavagarwal07/NamesiloCert/blob/master/hook.sh">here</a>.
The executable gets in its environment, two important variables:</p>

<pre><code>CERTBOT_DOMAIN:
domain for which challenge is running (eg. alexa.pallav.xyz)

CERTBOT_VALIDATION:
the value corresponding to the _acme-challenge TXT entry
</code></pre>

<p>TXT is a type of DNS entry. Thus, if I have the environmental variables set as:</p>

<pre><code>CERTBOT_DOMAIN=abc.pallav.xyz
CERTBOT_VALIDATION=somerandomstring
</code></pre>

<p>I need to add a TXT entry for <code>_acme-challenge.abc.pallav.xyz</code> with the value
<code>somerandomstring</code>.</p>

<p><br/></p>

<p><strong>Step 2: Calling Namesilo API</strong></p>

<p><a href="https://www.namesilo.com/api_reference.php">Namesilo thankfully has a very complete RESTful
API</a>. It took me a short while to
write a Go client that can interact with Namesilo via the API and add the
required DNS entries.
<a href="https://github.com/pallavagarwal07/NamesiloCert/blob/master/action.go">Here</a>
is the relevant code (along with helper files in that directory).</p>

<p>The executable called by Certbot is a wrapper around this client, and calls
this with the required arguments.</p>

<p><br/></p>

<p><strong>Step 3: Stall 15 minutes</strong></p>

<p>This is a bit hacky. The wrapper script checks if it is being called for the
last domain in the list. If so, it goes into a sleep for 15 minutes. This is
required because Namesilo publishes DNS changes every 15 (or 5 maybe?) minutes.
After 15 minutes, the script returns control to the certbot process.</p>

<p><br/></p>

<p><strong>Step 4: Let certbot run the verification.</strong></p>

<p>Almost done!</p>

<p><br/></p>

<p><strong>Step 5: Installation using GitLab API</strong></p>

<p>At this point we have generated our certificates. The only thing needed to be
done is the installation of those certificates into existing websites, in this
case, the ones hosted by GitLab. Now, GitLab too has a very comprehensive set
of RESTful APIs. I specifically use the <a href="https://docs.gitlab.com/ee/api/pages_domains.html">Pages Domains
API</a>.</p>

<p>This was rather straightforward, except for one bug on which I was stuck was
quite some time before finally posting it on stackoverflow. Like always, I figured
out a workaround before anybody could post a solution, but the question is still a
good record of what the problem was, so I'll just link to it here in case anybody
has a similar issue: <a href="https://stackoverflow.com/questions/47677846/">GitLab Pages API 404 error for certain
projects</a></p>

<p>The installation to GitLab code can be viewed
<a href="https://github.com/pallavagarwal07/NamesiloCert/blob/823fec691afe4929bb8079a73d348a244a553b93/gen_certs.sh#L38">here</a>.</p>

                            </div>
                        </div>
                    </div>
                </div>
                <hr /><br />
            </div>
            <div class="col-md-3 col-md-pull-7" id="recent">
                <h4>RECENT POSTS</h4>
                <ul class="nav nav-pills nav-stacked">
                    
                    <li>
                        <a href="/2018/01/07/Encrypted-posts-on-a-static-website/" class="color_change">Encrypted posts on a Static Website...</a>
                    </li>
                    
                    <li>
                        <a href="/2017/12/08/Automating-HTTPS-certs/" class="color_change">Automating HTTPS certs using Namesilo and...</a>
                    </li>
                    
                    <li>
                        <a href="/2017/12/05/Simplifying-Travis-with-Nix/" class="color_change">Simplifying CI with Nix</a>
                    </li>
                    
                    <li>
                        <a href="/2017/07/29/End-of-Diary/" class="color_change">An intern's views - End of...</a>
                    </li>
                    
                    <li>
                        <a href="/2017/07/24/Mistakes-are-okay/" class="color_change">Mistakes are okay</a>
                    </li>
                    
                </ul>
                <h4>RECENT TIPS</h4>
                <ul class="nav nav-pills nav-stacked">
                    
                    <li>
                        <a href="/2016/05/06/Ultimate-control-over-mobile-browser/" class="color_change">Ultimate control over Mobile Browser with...</a>
                    </li>
                    
                    <li>
                        <a href="/2016/04/27/SSH-keys/" class="color_change">Easy sharing of SSH keys</a>
                    </li>
                    
                    <li>
                        <a href="/2015/08/01/SSH-from-Windows/" class="color_change">Using SSH from Windows 10 without...</a>
                    </li>
                    
                    <li>
                        <a href="/2015/07/27/Boost-Python-Performance/" class="color_change">Cython: Boost Python Code Performance</a>
                    </li>
                    
                    <li>
                        <a href="/2015/07/01/Vim-Mappings/" class="color_change">Quick intro to custom Vim Mappings...</a>
                    </li>
                    
                </ul>
                <h4>TAGGED POSTS</h4>
                <ul class="nav nav-pills nav-stacked">
                    
                    <li>
                        <a href="/2016/05/13/Reference-Sheets-and-Useful-Links/" class="color_change">Reference Sheets and Useful Links</a>
                    </li>
                    
                </ul>
                <br />
                <br />
            </div>
            <div class="col-md-2">
            </div>
            <div class="row">
                <div class="col-md-7 col-md-offset-3 col-xs-10 col-xs-offset-1">
                    <div class="row">
                            <div class="col-xs-4">
                                <div class="fb-like" data-href="//www.varstack.com" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div>
                            </div>
                            <div class="col-xs-8 text-right">
                                <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
                                <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
                                <script src="/js/script.js"></script>
                                
                                
                                
                            </div>
                    </div>
                    <br/>
                </div>
                <div class="col-md-7 col-md-offset-3 col-xs-10 col-xs-offset-1">
                    <div id="disqus_thread"></div>
                    <script type="text/javascript" async>
/* * * CONFIGURATION VARIABLES * * */
var disqus_shortname = 'varstack';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-21768487-2', 'auto');
ga('send', 'pageview');
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="imagemodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                        Image Preview
                    </h4>
                </div>
                <div class="modal-body">
                    <img src="" id="imagepreview" style="max-height: 100%; max-width: 100%;">
                </div>
            </div>
        </div>
    </div>
